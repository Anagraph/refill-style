sources:
    mapzen:
        rasters:
            - normals
    normals:
        type: Raster
        url: https://tile.mapzen.com/mapzen/terrain/v1/normal/{z}/{x}/{y}.png
        url_params:
            api_key: global.sdk_mapzen_api_key
        max_zoom: 15

textures:
    palette:
        url: images/ramp.png
layers:
    earth:
        data: { source: mapzen }
        draw:
            polygons:
                style: earth-terrain-pattern
                order: function() { return feature.sort_rank || 0; }
                color: global.lightest_color
            lines:
                visible: false

    landuse:
        national_park:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true
            us_national_park:
                draw:
                    polygons:
                        style: landuse-terrain-pattern
                        visible: true

        conservation:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true

        national_forest_level_6:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true

        forest-landcover:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true

        parks-and-national-forests-not-national-park:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true
            national_park:
                draw:
                    polygons:
                        style: landuse-terrain-pattern
                        visible: true

        farm:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true

        university:
            enabled: false

        cemetery:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true

        golf_course:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true

        hospital:
            enabled: false

        sports_centre:
            enabled: false

        recreation_ground:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true

        stadium:
            enabled: false

        zoo:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true

        winter_sports:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true

        man-made:
            enabled: false

        tier5:
            tourism-related:
                draw:
                    polygons:
                        style: landuse-terrain-pattern
                        visible: true

            beach:
                draw:
                    polygons:
                        style: landuse-terrain-pattern
                        visible: true

        garden:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true

        parking:
            enabled: false

        pedestrian:
            enabled: false

        pitch:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true

        playground:
            draw:
                polygons:
                    style: landuse-terrain-pattern
                    visible: true

        school:
            enabled: false

        minor-landuse:
            enabled: false

        landuse-not-filtered:
            enabled: false

        retaining_wall:
            enabled: false

        fence:
            enabled: false

styles:
    riverlines:
        shaders:
            uniforms:
                u_tint: global.pattern_river_color

    functions-zoom:
        mix:
            - functions-easing
        shaders:
            defines:
                ZOOM_START: 14
                ZOOM_END: 20
                ZOOM_MAX: 'max(ZOOM_START, ZOOM_END)'
                ZOOM_FNC: linear
                ZOOM_IN: 0
                ZOOM_OUT: 1
            blocks:
                global: |
                    float zoom() {
                        return mix( ZOOM_IN,
                                    ZOOM_OUT,
                                    clamp( smoothstep(  ZOOM_START/ZOOM_MAX,
                                                        ZOOM_END/ZOOM_MAX,
                                                        max(u_map_position.z/ZOOM_MAX, 0.)), 0., 1.) );
                    }

                    float zoomEase() {
                        return mix( ZOOM_IN,
                                    ZOOM_OUT,
                                    (u_map_position.z-ZOOM_START)/(ZOOM_END-ZOOM_START) );
                    }

    elevation-dash:
        base: polygons
        mix:
            - polygons-diagonal-dash
        raster: custom
        shaders:
            defines:
                DASH_COLOR: color.rgb*.5
                DASH_BACKGROUND_COLOR: color.rgb
                DASH_SCALE: 10
                DASH_SIZE: 0.9
                DASH_TYPE: fill
                DASH_TILE_STYLE: tile
                DASH_DIR: vec3(-0.600,-0.420,0.560)
                NORMAL_TEXTURE_INDEX: 0
                DASH_MIN_SIZE: 0.8
                DASH_MAX_SIZE: 1
            blocks:
                normal: >
                    float shade = dot((sampleRaster(int(NORMAL_TEXTURE_INDEX)).rgb-.5)*2.,
                    DASH_DIR);

                    shade = mix(DASH_MIN_SIZE, DASH_MAX_SIZE, (shade*shade*shade)*4.);

    polygons-diagonal-dash:
        base: polygons
        mix:
            - space-tile
            - tiling-brick
            - tiling-tile
            - shapes-type
        shaders:
            defines:
                DASH_COLOR: color.rgb*.5
                DASH_BACKGROUND_COLOR: color.rgb
                DASH_SCALE: 10
                DASH_SIZE: 0.9
                DASH_TYPE: fill
                DASH_TILE_STYLE: tile
                PI: 3.141592653589793
            blocks:
                global: |
                    float dashDF(vec2 st) {
                        return min(cos((st.x-st.y)*PI),-cos((st.x+st.y+.5)*PI*.6666)*5.);
                    }
                color: |
                    color.rgb = mix(DASH_BACKGROUND_COLOR,
                                    DASH_COLOR,
                                    DASH_TYPE( DASH_SIZE, dashDF(DASH_TILE_STYLE(getTileCoords()*DASH_SCALE,3.))) );

    shapes-type:
        mix:
            - functions-aastep
        shaders:
            defines:
                STROKE: 0.15
            blocks:
                global: |
                    float fill (in float size, in float x) {
                        return 1.-aastep(size, x);
                    }

                    float stroke (in float size, in float x) {
                        return aastep(size, x+STROKE*.5) - aastep(size, x-STROKE*.5);
                    }

    elevation-normal:
        raster: custom
        shaders:
            defines:
                NORMAL_TEXTURE_INDEX: 0
            blocks:
                normal: |
                    vec4 normal_elv_raster = sampleRaster(int(NORMAL_TEXTURE_INDEX));
                    normal = (normal_elv_raster.rgb-.5)*2.;

    polygons-dots:
        base: polygons
        mix:
            - space-tile
            - tiling-brick
            - tiling-tile
            - shapes-circle
        shaders:
            defines:
                DOTS_COLOR: color.rgb*.5
                DOTS_BACKGROUND_COLOR: color.rgb
                DOTS_SCALE: 10
                DOTS_SIZE: 0.41
                DOTS_TYPE: fill
                DOTS_TILE_STYLE: brick
            blocks:
                color: |
                    color.rgb = mix(DOTS_BACKGROUND_COLOR,
                                    DOTS_COLOR,
                                    DOTS_TYPE( DOTS_SIZE, circleDF(vec2(0.5)-DOTS_TILE_STYLE(getTileCoords()*DOTS_SCALE,2.))) );
    shapes-circle:
        mix:
            - shapes-type
        shaders:
            blocks:
                global: |
                    // get distance field of a Circle
                    float circleDF (vec2 st) {
                                    return dot(st,st)*3.03;
                    }

                    // Draw a circle in the middle of the ST space
                    float circle (vec2 st, float radius) {
                                    return fill(radius, circleDF(st-vec2(0.5)));
                    }

                    // Draw a circle in the middle of the ST space
                    float circleBorder (vec2 st, float radius) {
                                    return stroke(radius, circleDF(st-vec2(0.5)));
                    }

    # dot terrain from Patricio's example
    # https://mapzen.com/tangram/play/?scene=https://tangrams.github.io/tangram-sandbox/styles/callejas.yaml&lines=116#10.9329/38.3394/-122.3068

    earth-terrain-pattern:
        base: polygons
        mix: [elevation-ramp-earth, elevation-normal, functions-zoom, polygons-dots]
        shaders:
            defines:
                ZOOM_START: 0.
                ZOOM_END: 13.
                DOTS_DIR: vec3(0.600,-0.950,0.520)
                # DOTS_DIR: vec3(0.600,-0.950,0.600)
                # DOTS_COLOR: color.rgb
                DOTS_COLOR: vec3(0)
                DOTS_BACKGROUND_COLOR: vec3(1.0)
                DOTS_SCALE: 30
                DOTS_SIZE: mix(shade*10.,shade*2.,zoom())
            blocks:
                normal: |
                    float shade = dot(normal, DOTS_DIR);
                    // subtract .1 to increase contrast a bit
                    shade = shade*shade*shade * -1. + .3;
                    // reset normal to prevent standard terrain shading mixing with dots
                    normal = vec3(0,0,1);

    elevation-ramp-earth:
        mix: colorized-earth
        shaders:
            uniforms:
                u_ramp: palette
            blocks:
                color: |
                    color = texture2D(u_ramp, vec2((1.-normal_elv_raster.a),.5));
        raster: custom

    colorized-earth:
        shaders:
            uniforms:
                u_tint: global.earth_dot_color
                u_fill: global.earth_fill_color
            blocks:
                filter: |
                    color.rgb = mix(u_tint.rgb, u_fill.rgb, color.rgb);

    landuse-terrain-pattern:
        base: polygons
        mix: [elevation-ramp-landuse, elevation-normal, functions-zoom, polygons-dots]
        shaders:
            defines:
                ZOOM_START: 0.
                ZOOM_END: 13.
                DOTS_DIR: vec3(0.600,-0.950,0.520)
                # DOTS_DIR: vec3(0.600,-0.950,0.600)
                # DOTS_COLOR: color.rgb
                DOTS_COLOR: vec3(0)
                DOTS_BACKGROUND_COLOR: vec3(1.0)
                DOTS_SCALE: 30
                DOTS_SIZE: mix(shade*10.,shade*2.,zoom())
            blocks:
                normal: |
                    float shade = dot(normal, DOTS_DIR);
                    // subtract .1 to increase contrast a bit
                    shade = shade*shade*shade * -1. + .3;
                    // reset normal to prevent standard terrain shading mixing with dots
                    normal = vec3(0,0,1);

    elevation-ramp-landuse:
        mix: colorized-landuse
        shaders:
            uniforms:
                u_ramp: palette
            blocks:
                color: |
                    color = texture2D(u_ramp, vec2((1.-normal_elv_raster.a),.5));
        raster: custom

    colorized-landuse:
        shaders:
            uniforms:
                u_tint: global.landuse_dot_color
                u_fill: global.landuse_fill_color
            blocks:
                filter: |
                    color.rgb = mix(u_tint.rgb, u_fill.rgb, color.rgb);